<?xml version="1.0" encoding="ISO-8859-1"?>
<modification>
  <name>CotaMensalEmpenho</name>
  <id>CotaMensalEmpenho</id>
  <ecidade-version>2.3.39</ecidade-version>
  
  <file path='forms/db_frmempempenhonota.php'>
    <operation>
      <search><![CDATA[<input type="button" id="btnLancarCotasMensais" value="Manutenção das Cotas Mensais" onclick="manutencaoCotasMensais();" <?php echo $lDisable; ?> />]]></search>
      <add position="replace">
        <![CDATA[]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[<!-- Plugin - Cotas mensais no empenho - Parte 1 -->]]></search>
      <add position="after">
        <![CDATA[      <fieldset>
        <legend>Cotas</legend>
          <table>
            <tr>
              <td nowrap>Janeiro:   </td><td align=right><? db_input('cota_1',10,4,true,'text',$db_opcao,'onChange=formatarValor(this); onBlur=formatarValor(this);','','','text-align:right')?></td>
              <td nowrap>Fevereiro: </td><td align=right><? db_input('cota_2',10,4,true,'text',$db_opcao,'onChange=formatarValor(this); onBlur=formatarValor(this);','','','text-align:right')?></td>
              <td nowrap>Março:     </td><td align=right><? db_input('cota_3',10,4,true,'text',$db_opcao,'onChange=formatarValor(this); onBlur=formatarValor(this);','','','text-align:right')?></td>
              <td nowrap>Abril:     </td><td align=right><? db_input('cota_4',10,4,true,'text',$db_opcao,'onChange=formatarValor(this); onBlur=formatarValor(this);','','','text-align:right')?></td>
            </tr>
            <tr>
              <td nowrap>Maio:   </td><td align=right><? db_input('cota_5',10,4,true,'text',$db_opcao,'onChange=formatarValor(this); onBlur=formatarValor(this);','','','text-align:right')?></td>
              <td nowrap>Junho:  </td><td align=right><? db_input('cota_6',10,4,true,'text',$db_opcao,'onChange=formatarValor(this); onBlur=formatarValor(this);','','','text-align:right')?></td>
              <td nowrap>Julho:  </td><td align=right><? db_input('cota_7',10,4,true,'text',$db_opcao,'onChange=formatarValor(this); onBlur=formatarValor(this);','','','text-align:right')?></td>
              <td nowrap>Agosto: </td><td align=right><? db_input('cota_8',10,4,true,'text',$db_opcao,'onChange=formatarValor(this); onBlur=formatarValor(this);','','','text-align:right')?></td>
            </tr>
            <tr>
              <td nowrap>Setembro: </td><td align=right><? db_input('cota_9', 10,4,true,'text',$db_opcao,'onChange=formatarValor(this); onBlur=formatarValor(this);','','','text-align:right')?></td>
              <td nowrap>Outubro:  </td><td align=right><? db_input('cota_10',10,4,true,'text',$db_opcao,'onChange=formatarValor(this); onBlur=formatarValor(this);','','','text-align:right')?></td>
              <td nowrap>Novembro: </td><td align=right><? db_input('cota_11',10,4,true,'text',$db_opcao,'onChange=formatarValor(this); onBlur=formatarValor(this);','','','text-align:right')?></td>
              <td nowrap>Dezembro: </td><td align=right><? db_input('cota_12',10,4,true,'text',$db_opcao,'onChange=formatarValor(this); onBlur=formatarValor(this);','','','text-align:right')?></td>
            </tr>
            <tr>
              <td></td><td></td>
              <td></td><td></td>
              <td></td><td><? db_input('e54_valor', 10, $Ie54_valor, true, 'hidden') ?></td>
              <td nowrap><b>Total das Cotas: <b></td><td nowrap align="right"><b id='total_cotas'>0,00</b></td>
            </tr>
          </table>
      </fieldset>]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[function manutencaoCotasMensais () {

    oViewCotasMensais = new ViewCotasMensais('oViewCotasMensais', $F('e60_numemp'));
    oViewCotasMensais.setReadOnly(false);
    oViewCotasMensais.abrirJanela();
  }]]></search>
      <add position="replace">
        <![CDATA[/* Plugin Cota mensal no empenho - Parte 2 */
  function formatarValor(oObjeto) {

    oObjeto.setValue(js_formatar(oObjeto.getValue(), 'f'));
    atualizarTotal();
  }

  function atualizarTotal() {

    var nValorTotal = 0;
    for (var i = 1; i <= 12; i++) {
      nValorTotal += js_strToFloat(document.getElementById('cota_'+i).value);
    }
    document.getElementById('total_cotas').innerHTML = js_formatar(nValorTotal, 'f');
  }

  function validarCotas() {

    var nValorTotal  = js_formatar(document.getElementById('total_cotas').innerHTML, 'f');
    var nValorAutEmp = js_formatar(document.getElementById('e54_valor').value, 'f');

    if (nValorTotal != nValorAutEmp) {
      alert("A soma das cotas deve ser igual ao valor da autorização.");
      return false;
    }
    return true;
  }

  function validarCotasTipoEmp() {
  	var mesAtual = parseInt("<?php echo date('m',db_getsession('DB_datausu'))?>");
  	var nValor   = js_formatar(document.getElementById('e54_valor').value, 'f');
  	//Só verifica as cotas dos meses seguintes
  	for (var i = mesAtual; i <= 12; i++) {
    	if (document.getElementById('e54_codtipo').value == 1){
        document.getElementById('cota_'+i).disabled 	= true;
      } else {
      	document.getElementById('cota_'+i).disabled 	= false;
      }
		  document.getElementById('cota_'+i).value 		= 0;
    }
	  document.getElementById('cota_'+mesAtual).value = nValor;
    atualizarTotal();
  }

  function verificaCotasMes(){
  	var mesAtual = parseInt("<?php echo date('m',db_getsession('DB_datausu'))?>");
  	var nValor   = js_formatar(document.getElementById('e54_valor').value, 'f');
  	for (var i = 1; i <= 12; i++) {
		if (i < mesAtual){
	   		document.getElementById('cota_'+i).disabled = true;
	  	}
	  	document.getElementById('cota_'+i).value 		= 0;
   	}
	document.getElementById('cota_'+mesAtual).value = nValor;
  }

  document.observe("dom:loaded", function() {
  	verificaCotasMes();
        validarCotasTipoEmp();
  	atualizarTotal();
  })]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[/* Plugin Cota mensal no empenho - Parte 3 */]]></search>
      <add position="after">
        <![CDATA[    if(!validarCotas()){
      return false;
    }]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[/* Plugin Cota mensal no empenho - Parte 4 */
            db_selectrecord("e54_codtipo",$result,true,$db_opcao);]]></search>
      <add position="replace">
        <![CDATA[/* Plugin Cota mensal no empenho - Parte 4 */
            db_selectrecord("e54_codtipo",$result,true,$db_opcao,'','','','','validarCotasTipoEmp()');]]>
      </add>
    </operation>
  </file>

  <file path='forms/db_frmempanularempenho.php'>
    <operation>
      <search><![CDATA[<!-- Plugin Cota Mensal Empenho - Parte 1 -->]]></search>
      <add position="after">
        <![CDATA[
      </td>
          </tr>
          <tr>
            <td>
                <fieldset>
                  <legend>Cotas</legend>
                    <table>
                      <tr>
                        <td nowrap>Janeiro:   </td><td align=right><? db_input('cota_1',10,4,true,'text',$db_opcao,'onChange=formatarValor(this); onBlur=formatarValor(this);','','','text-align:right')?></td>
                        <td nowrap>Fevereiro: </td><td align=right><? db_input('cota_2',10,4,true,'text',$db_opcao,'onChange=formatarValor(this); onBlur=formatarValor(this);','','','text-align:right')?></td>
                        <td nowrap>Março:     </td><td align=right><? db_input('cota_3',10,4,true,'text',$db_opcao,'onChange=formatarValor(this); onBlur=formatarValor(this);','','','text-align:right')?></td>
                        <td nowrap>Abril:     </td><td align=right><? db_input('cota_4',10,4,true,'text',$db_opcao,'onChange=formatarValor(this); onBlur=formatarValor(this);','','','text-align:right')?></td>
                      </tr>
                      <tr>
                        <td nowrap></td><td align=right><p id='disponivel_cota_1'></p></td>
                        <td nowrap></td><td align=right><p id='disponivel_cota_2'></p></td>
                        <td nowrap></td><td align=right><p id='disponivel_cota_3'></p></td>
                        <td nowrap></td><td align=right><p id='disponivel_cota_4'></p></td>
                      </tr>
                      <tr>
                        <td nowrap>Maio:   </td><td align=right><? db_input('cota_5',10,4,true,'text',$db_opcao,'onChange=formatarValor(this); onBlur=formatarValor(this);','','','text-align:right')?></td>
                        <td nowrap>Junho:  </td><td align=right><? db_input('cota_6',10,4,true,'text',$db_opcao,'onChange=formatarValor(this); onBlur=formatarValor(this);','','','text-align:right')?></td>
                        <td nowrap>Julho:  </td><td align=right><? db_input('cota_7',10,4,true,'text',$db_opcao,'onChange=formatarValor(this); onBlur=formatarValor(this);','','','text-align:right')?></td>
                        <td nowrap>Agosto: </td><td align=right><? db_input('cota_8',10,4,true,'text',$db_opcao,'onChange=formatarValor(this); onBlur=formatarValor(this);','','','text-align:right')?></td>
                      </tr>
                      <tr>
                        <td nowrap></td><td align=right><p id='disponivel_cota_5'></p></td>
                        <td nowrap></td><td align=right><p id='disponivel_cota_6'></p></td>
                        <td nowrap></td><td align=right><p id='disponivel_cota_7'></p></td>
                        <td nowrap></td><td align=right><p id='disponivel_cota_8'></p></td>
                      </tr>
                      <tr>
                        <td nowrap>Setembro: </td><td align=right><? db_input('cota_9', 10,4,true,'text',$db_opcao,'onChange=formatarValor(this); onBlur=formatarValor(this);','','','text-align:right')?></td>
                        <td nowrap>Outubro:  </td><td align=right><? db_input('cota_10',10,4,true,'text',$db_opcao,'onChange=formatarValor(this); onBlur=formatarValor(this);','','','text-align:right')?></td>
                        <td nowrap>Novembro: </td><td align=right><? db_input('cota_11',10,4,true,'text',$db_opcao,'onChange=formatarValor(this); onBlur=formatarValor(this);','','','text-align:right')?></td>
                        <td nowrap>Dezembro: </td><td align=right><? db_input('cota_12',10,4,true,'text',$db_opcao,'onChange=formatarValor(this); onBlur=formatarValor(this);','','','text-align:right')?></td>
                      </tr>
                      <tr>
                        <td nowrap></td><td align=right><p id='disponivel_cota_9'></p></td>
                        <td nowrap></td><td align=right><p id='disponivel_cota_10'></p></td>
                        <td nowrap></td><td align=right><p id='disponivel_cota_11'></p></td>
                        <td nowrap></td><td align=right><p id='disponivel_cota_12'></p></td>
                      </tr>
                      <tr>
                        <td></td><td></td>
                        <td></td><td></td>
                        <td></td><td><? db_input('e54_valor', 10, $Ie54_valor, true, 'hidden') ?></td>
                        <td nowrap><b>Total de anulação das Cotas: <b></td><td nowrap align="right"><b id='total_cotas'>0,00</b></td>
                      </tr>
                    </table>
                </fieldset>
            </td>
          </tr>]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[/* Plugin Cota Mensal Empenho - Parte 2 */]]></search>
      <add position="after">
        <![CDATA[  
  //Traz os dados das cotas (no momento só utiliza o saldo disponível para anular)
  function carregarCotasEmpenho(iEmpenho) {
    js_divCarregando("Aguarde, carregando dados das cotas","msgBox");
    strJson = '{"method":"getCotasMensaisAnulacao","pars":"'+iEmpenho+'","iEmpenho":"'+iEmpenho+'"}';
    var url     = 'emp4_empenhocotamensalanulacao.RPC.php';
    var oAjax   = new Ajax.Request(
      url,
      {
        method: 'post',
        parameters: 'json='+strJson,
        onComplete: js_saidaCarregaCotas
      }
    );
  }

  function js_saidaCarregaCotas(oAjax) {
    js_removeObj("msgBox");
    
    obj = eval("("+oAjax.responseText+")");

    if (obj.status == 1){

      for (i = 0; i < obj.numCotas;i++){
        
        with (obj.aCotas[i]) {
          //document.getElementById('cota_'+e05_mes).value = js_formatar(valoranulado, 'f');
          document.getElementById('disponivel_cota_'+e05_mes).innerHTML = "Disp.: "+js_formatar(saldocota, 'f');
        }
        atualizarTotal();
      }
      return true;
    } else {

      mensagem = obj.mensagem.replace(/\+/g," ");
      mensagem = unescape(mensagem);
      alert(mensagem);
      return false;
    }
  }

  //formata o campo
  function formatarValor(oObjeto) {

    oObjeto.setValue(js_formatar(oObjeto.getValue(), 'f'));
    atualizarTotal();
  }

  //atualiza o total das cotas
  function atualizarTotal() {

    var nValorTotal = 0;
    for (var i = 1; i <= 12; i++) {
      nValorTotal += js_strToFloat(document.getElementById('cota_'+i).value);
    }
    document.getElementById('total_cotas').innerHTML = js_formatar(nValorTotal, 'f');
  }

  //realiza as validações necessarias para salvar
  function validarCotas() {

    var sValorTotal = document.getElementById('total_cotas').innerHTML.replace(".", "");//.replace(/[.,]/g, ""));
    var nValorTotal = parseFloat(sValorTotal.replace(",", "."));    

    var sValorAnu   = document.getElementById('valortotal').innerHTML.replace(".", "");
    var nValorAnu   = parseFloat(sValorAnu.replace(",", "."));

    for (var i = 1; i <= 12; i++) {
      var sValorCota  = document.getElementById('cota_'+i).value.replace(".", "");
      var nValorCota  = parseFloat(sValorCota.replace(",", "."));

      var sValorSaldo = document.getElementById('disponivel_cota_'+i).innerHTML.replace("Disp.: ", "").replace(".", "");
      var nValorSaldo = parseFloat(sValorSaldo.replace(",", "."));

      if (nValorCota > nValorSaldo) {
        alert("O valor da cota do mês "+i+" não pode ser maior que o saldo da cota disponível para anulação.");
        return false;
      }
    }

    if (nValorTotal != nValorAnu) {
      alert("A soma das cotas deve ser igual ao valor da anulação.");
      return false;
    }

    return true;
  }

  //salvar as anulações das cotas
  function salvarAnulacoesCotas(iEmpenho){
    
  if(!validarCotas()){
    return false;
  }

  js_divCarregando("Aguarde, carregando dados das cotas","msgBox");
  var aCotas = new Array();
  for (var i = 1; i <= 12; i++) {
    var oCotasAnulacao = new Object();
    nValorCota  = js_strToFloat(document.getElementById('cota_'+i).value); 
    if (nValorCota > 0) {     
      oCotasAnulacao.mes   = i;
      oCotasAnulacao.valor = parseFloat(nValorCota);
      aCotas.push(oCotasAnulacao);
    }
  }

  strJson = '{"method":"salvar","pars":"'+iEmpenho+'","iEmpenho":"'+iEmpenho+'","aCotas":"'+js_objectToJson(aCotas)+'"}';
  var url     = 'emp4_empenhocotamensalanulacao.RPC.php';
  var oAjax   = new Ajax.Request(
    url,
    {
      method: 'post',
      parameters: 'json='+strJson,
      onComplete: js_saidaSalvaCotas
    }
  );

  }

  function js_saidaSalvaCotas(oAjax) {
  
    js_removeObj("msgBox");
    obj = eval("("+oAjax.responseText+")");

    if (obj.status == 1){
      verificaCotasMes();
      alert(obj.mensagem);
      return true;
    } else {
      alert("Não foi possível inserir as anulações das cotas.");
      alert(obj.mensagem);
      return false;
    }
  }

  //bloqueia as cotas de meses anteriores
  function verificaCotasMes(){
    var mesAtual = parseInt("<?php echo date('m',db_getsession('DB_datausu'))?>");
    for (var i = 1; i <= 12; i++) {
      if (i < mesAtual){
        document.getElementById('cota_'+i).disabled = true;
      }
      document.getElementById('cota_'+i).value = 0;
      formatarValor(document.getElementById('cota_'+i));
    }
  }

  document.observe("dom:loaded", function() {
    verificaCotasMes();
    atualizarTotal();
  })]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[/* Plugin Cota Mensal Empenho - Parte 3 */]]></search>
      <add position="after">
        <![CDATA[
    carregarCotasEmpenho(obj.e60_numemp);]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[/* Plugin Cota Mensal Empenho - Parte 4 */]]></search>
      <add position="after">
        <![CDATA[
      if(salvarAnulacoesCotas($F('e60_numemp')) == false) {
        return false;
      }]]>
      </add>
    </operation>
  </file>

  <file path='forms/db_frmempempenhoaltera.php'>
    <operation>
      <search><![CDATA[<input type="button" id="btnLancarCotasMensais" value="Manutenção de Cotas Mensais" onclick="manutencaoCotasMensais()" />]]></search>
      <add position="replace">
        <![CDATA[]]>
      </add>
    </operation>
  </file>

  <file path='emp4_empempenho004.php'>
    <operation>
      <search><![CDATA[/* Plugin Cota Mensal Empenho - Parte 1 */]]></search>
      <add position="after">
        <![CDATA[
    require_once(modification('model/empenho/EmpenhoFinanceiroRepository.model.php'));
    require_once(modification('model/empenho/EmpenhoFinanceiro.model.php'));
    require_once(modification('model/empenho/EmpenhoCotaMensal.model.php'));

    $oEmpenho = EmpenhoFinanceiroRepository::getEmpenhoFinanceiroPorNumero($e60_numemp);
    $aCotas = array();
    for ($mes=1; $mes <= 12; $mes++) { 
      $nValor = str_replace(".", "", ${"cota_".$mes});
      $oCotaMensal = new EmpenhoCotaMensal();
      $oCotaMensal->setMes($mes);
      $oCotaMensal->setValor((float)str_replace(",", ".", $nValor));
      $aCotas[] = $oCotaMensal;
    }

    $oEmpenho->adicionarCotas($aCotas);]]>
      </add>
    </operation>
  </file>

</modification>
